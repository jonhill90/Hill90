---
# Optimized Hill90 VPS Bootstrap Playbook
# Consolidated playbook optimized for speed (target: <5 minutes)
# Assumes post-install script has pre-cached binaries during OS rebuild

- name: Bootstrap Hill90 VPS (Optimized)
  hosts: vps
  become: yes
  gather_facts: yes

  vars_files:
    - ../inventory/group_vars/all.yml

  vars:
    cache_dir: /opt/hill90/cache

  pre_tasks:
    - name: Display bootstrap start message
      debug:
        msg: "Starting optimized Hill90 VPS bootstrap for {{ inventory_hostname }}"

  tasks:
    # ========================================
    # Phase 1: Base System Setup (parallel where possible)
    # ========================================

    - name: Create deploy user
      user:
        name: "{{ deploy_user }}"
        groups: wheel
        append: yes
        shell: /bin/bash
        create_home: yes
        home: "{{ deploy_home }}"
        state: present

    - name: Create .ssh directory for deploy user
      file:
        path: "{{ deploy_home }}/.ssh"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0700'

    - name: Copy authorized_keys from root to deploy user
      copy:
        src: /root/.ssh/authorized_keys
        dest: "{{ deploy_home }}/.ssh/authorized_keys"
        remote_src: yes
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0600'
      ignore_errors: yes

    - name: Grant sudo privileges to deploy user
      lineinfile:
        path: /etc/sudoers.d/{{ deploy_user }}
        line: "{{ deploy_user }} ALL=(ALL) NOPASSWD:ALL"
        create: yes
        validate: 'visudo -cf %s'
        mode: '0440'

    - name: Create application directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0755'
      loop:
        - "{{ app_directory }}"
        - "{{ deploy_home }}"

    # ========================================
    # Phase 2: Network Security & Tailscale
    # ========================================

    - name: Install firewalld
      dnf:
        name: firewalld
        state: present

    - name: Enable and start firewalld
      systemd:
        name: firewalld
        enabled: yes
        state: started

    - name: Configure firewall rules (HTTP/HTTPS/SSH public)
      firewalld:
        service: "{{ item }}"
        permanent: yes
        state: enabled
        immediate: yes
      loop:
        - http
        - https
        - ssh

    # Tailscale installation
    - name: Check if Tailscale is installed
      stat:
        path: /usr/bin/tailscale
      register: tailscale_binary

    - name: Download Tailscale install script
      get_url:
        url: https://tailscale.com/install.sh
        dest: /tmp/tailscale-install.sh
        mode: '0755'
      when: not tailscale_binary.stat.exists

    - name: Install Tailscale
      command: sh /tmp/tailscale-install.sh
      args:
        creates: /usr/bin/tailscale
      when: not tailscale_binary.stat.exists

    - name: Remove install script
      file:
        path: /tmp/tailscale-install.sh
        state: absent

    - name: Enable and start tailscaled service
      systemd:
        name: tailscaled
        enabled: yes
        state: started

    - name: Check if Tailscale is already authenticated
      command: tailscale status
      register: tailscale_status
      changed_when: false
      failed_when: false

    - name: Join Tailscale network
      command: >
        tailscale up
        --authkey={{ lookup('env', 'TAILSCALE_AUTH_KEY') }}
        --hostname={{ vps_hostname | default('hill90-vps') }}
        --accept-routes
        --ssh
      when: "'Logged out' in tailscale_status.stdout or tailscale_status.rc != 0"
      register: tailscale_auth
      failed_when: tailscale_auth.rc != 0 and 'already logged in' not in tailscale_auth.stderr

    - name: Get Tailscale status
      command: tailscale status --json
      register: tailscale_status_json
      changed_when: false

    - name: Extract Tailscale IPv4 address
      set_fact:
        tailscale_ipv4: "{{ (tailscale_status_json.stdout | from_json).Self.TailscaleIPs | select('match', '^[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+$') | first }}"

    - name: Save Tailscale IP to fact file
      copy:
        content: "{{ tailscale_ipv4 }}"
        dest: /opt/hill90/.tailscale_ip
        owner: deploy
        group: deploy
        mode: '0644'

    - name: Display Tailscale configuration
      debug:
        msg:
          - "Tailscale successfully configured!"
          - "Hostname: {{ vps_hostname | default('hill90-vps') }}"
          - "IPv4: {{ tailscale_ipv4 }}"

    # SSH Lockdown (Tailscale-only)
    - name: Lock SSH to Tailscale network only (100.64.0.0/10)
      firewalld:
        rich_rule: 'rule family="ipv4" source address="100.64.0.0/10" service name="ssh" accept'
        permanent: yes
        state: enabled
        immediate: yes

    - name: Remove public SSH access
      firewalld:
        service: ssh
        permanent: yes
        state: disabled
        immediate: yes

    # SSH Hardening
    - name: Configure SSH hardening
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
      loop:
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^#?ChallengeResponseAuthentication', line: 'ChallengeResponseAuthentication no' }
        - { regexp: '^#?MaxAuthTries', line: 'MaxAuthTries 3' }
        - { regexp: '^#?ClientAliveInterval', line: 'ClientAliveInterval 300' }
        - { regexp: '^#?ClientAliveCountMax', line: 'ClientAliveCountMax 2' }
      notify: restart sshd

    - name: Install fail2ban
      dnf:
        name: fail2ban
        state: present

    - name: Configure fail2ban for SSH
      copy:
        dest: /etc/fail2ban/jail.local
        content: |
          [DEFAULT]
          bantime = 3600
          findtime = 600
          maxretry = 3

          [sshd]
          enabled = true
          port = ssh
          logpath = /var/log/secure
        mode: '0644'
      notify: restart fail2ban

    - name: Enable and start fail2ban
      systemd:
        name: fail2ban
        enabled: yes
        state: started

    # ========================================
    # Phase 3: Development Tools (use cached binaries)
    # ========================================

    - name: Create secrets directory
      file:
        path: "{{ age_key_path }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0700'

    # Use cached binaries from post-install script
    - name: Install SOPS from cache
      copy:
        src: "{{ cache_dir }}/sops"
        dest: /usr/local/bin/sops
        mode: '0755'
        remote_src: yes
      when: cache_dir is defined

    - name: Install age binaries from cache
      copy:
        src: "{{ cache_dir }}/{{ item }}"
        dest: /usr/local/bin/{{ item }}
        mode: '0755'
        remote_src: yes
      loop:
        - age
        - age-keygen
      when: cache_dir is defined

    # Git and repository setup
    - name: Clone Hill90 repository
      git:
        repo: "{{ git_repo_url }}"
        dest: "{{ app_directory }}"
        version: "{{ git_branch | default('main') }}"
        force: yes
      become_user: "{{ deploy_user }}"

    - name: Set repository ownership
      file:
        path: "{{ app_directory }}"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        recurse: yes

    # Age key transfer
    - name: Transfer age encryption key
      copy:
        content: "{{ lookup('file', age_key_source) }}"
        dest: "{{ age_key_path }}/keys.txt"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0600'
      no_log: true

    - name: Create symlink to age key in app directory
      file:
        src: "{{ age_key_path }}/keys.txt"
        dest: "{{ app_directory }}/infra/secrets/keys/age-prod.key"
        state: link
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        force: yes

    # ========================================
    # Phase 4: Docker Verification (already installed)
    # ========================================

    - name: Verify Docker is installed (from post-install)
      command: docker --version
      register: docker_version
      changed_when: false
      failed_when: docker_version.rc != 0

    - name: Verify Docker Compose is installed
      command: docker compose version
      register: compose_version
      changed_when: false
      failed_when: compose_version.rc != 0

    - name: Add deploy user to docker group
      user:
        name: "{{ deploy_user }}"
        groups: docker
        append: yes

    - name: Display Docker versions
      debug:
        msg:
          - "Docker: {{ docker_version.stdout }}"
          - "Docker Compose: {{ compose_version.stdout }}"

  post_tasks:
    - name: Display bootstrap completion message
      debug:
        msg:
          - "âœ“ Optimized bootstrap completed!"
          - "Tailscale IP: {{ tailscale_ipv4 }}"
          - "SSH: ssh -i ~/.ssh/remote.hill90.com deploy@{{ tailscale_ipv4 }}"
          - "Next: Deploy services via Tailscale IP"

  handlers:
    - name: restart docker
      systemd:
        name: docker
        state: restarted

    - name: restart sshd
      systemd:
        name: sshd
        state: restarted

    - name: restart fail2ban
      systemd:
        name: fail2ban
        state: restarted
