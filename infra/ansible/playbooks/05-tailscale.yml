---
# Tailscale Installation Playbook
# Installs Tailscale binary and joins the tailnet
# Auth key is managed via Terraform (infra/terraform/tailscale)

- name: Add Tailscale repository
  yum_repository:
    name: tailscale-stable
    description: Tailscale stable
    baseurl: https://pkgs.tailscale.com/stable/rhel/9/x86_64
    enabled: yes
    gpgcheck: yes
    gpgkey: https://pkgs.tailscale.com/stable/rhel/9/x86_64/repo.gpg
    repo_gpgcheck: yes

- name: Install Tailscale
  dnf:
    name: tailscale
    state: present

- name: Enable and start tailscaled service
  systemd:
    name: tailscaled
    enabled: yes
    state: started

- name: Check if Tailscale is already authenticated
  command: tailscale status
  register: tailscale_status
  changed_when: false
  failed_when: false

- name: Join Tailscale network
  command: >
    tailscale up
    --authkey={{ lookup('env', 'TAILSCALE_AUTH_KEY') }}
    --hostname={{ vps_hostname | default('hill90-vps') }}
    --accept-routes
    --ssh
  when: "'Logged out' in tailscale_status.stdout or tailscale_status.rc != 0"
  register: tailscale_auth
  failed_when: tailscale_auth.rc != 0 and 'already logged in' not in tailscale_auth.stderr

- name: Get Tailscale status
  command: tailscale status --json
  register: tailscale_status_json
  changed_when: false

- name: Extract Tailscale IPv4 address
  set_fact:
    tailscale_ipv4: "{{ (tailscale_status_json.stdout | from_json).Self.TailscaleIPs | select('match', '^[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+$') | first }}"

- name: Display Tailscale configuration
  debug:
    msg:
      - "Tailscale successfully configured!"
      - "Hostname: {{ vps_hostname | default('hill90-vps') }}"
      - "IPv4: {{ tailscale_ipv4 }}"
      - "SSH enabled: yes"
      - "Accept routes: yes"

- name: Save Tailscale IP to fact file
  copy:
    content: "{{ tailscale_ipv4 }}"
    dest: /opt/hill90/.tailscale_ip
    owner: deploy
    group: deploy
    mode: '0644'
