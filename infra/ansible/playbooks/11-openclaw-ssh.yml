---
# OpenClaw SSH Setup
# Generates SSH keys for OpenClaw container to access VPS host

- name: Generate OpenClaw SSH key pair (on control machine)
  delegate_to: localhost
  become: false
  community.crypto.openssh_keypair:
    path: "{{ playbook_dir }}/../../secrets/openclaw-ssh/id_ed25519"
    type: ed25519
    comment: "openclaw@hill90"
    mode: '0600'
  register: openclaw_ssh_key

- name: Create OpenClaw SSH config (on control machine)
  delegate_to: localhost
  become: false
  copy:
    dest: "{{ playbook_dir }}/../../secrets/openclaw-ssh/config"
    mode: '0600'
    content: |
      Host hill90-host
          HostName remote.hill90.com
          User {{ deploy_user }}
          IdentityFile ~/.ssh/id_ed25519
          StrictHostKeyChecking no
          UserKnownHostsFile=/dev/null

- name: Add OpenClaw public key to deploy user's authorized_keys
  become: true
  become_user: "{{ deploy_user }}"
  authorized_key:
    user: "{{ deploy_user }}"
    state: present
    key: "{{ openclaw_ssh_key.public_key }}"
    comment: "openclaw-container-access"

- name: Ensure deploy user can run Docker commands without sudo
  become: true
  user:
    name: "{{ deploy_user }}"
    groups: docker
    append: true

- name: Display SSH setup completion
  debug:
    msg:
      - "OpenClaw SSH keys generated successfully"
      - "Public key added to {{ deploy_user }}@{{ ansible_host }}"
      - "OpenClaw container can now SSH to host using: ssh hill90-host"
