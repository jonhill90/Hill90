---
# Age Key Transfer Playbook
# Transfers the age encryption key from local machine to VPS
# This key is used for SOPS encryption/decryption of secrets

- name: Ensure age keys directory exists on VPS
  file:
    path: /opt/hill90/secrets/keys
    state: directory
    owner: deploy
    group: deploy
    mode: '0700'

- name: Check for local age key
  stat:
    path: "{{ lookup('env', 'LOCAL_AGE_KEY_PATH') | default('~/.config/sops/age/keys.txt') }}"
  delegate_to: localhost
  register: local_age_key

- name: Fail if local age key not found
  fail:
    msg: "Age key not found at {{ lookup('env', 'LOCAL_AGE_KEY_PATH') | default('~/.config/sops/age/keys.txt') }}"
  when: not local_age_key.stat.exists

- name: Transfer age key to VPS
  copy:
    src: "{{ lookup('env', 'LOCAL_AGE_KEY_PATH') | default('~/.config/sops/age/keys.txt') }}"
    dest: /opt/hill90/secrets/keys/keys.txt
    owner: deploy
    group: deploy
    mode: '0600'

- name: Ensure app secrets directory exists
  file:
    path: /opt/hill90/app/infra/secrets/keys
    state: directory
    owner: deploy
    group: deploy
    mode: '0700'

- name: Create symlink in app directory
  file:
    src: /opt/hill90/secrets/keys/keys.txt
    dest: /opt/hill90/app/infra/secrets/keys/age-prod.key
    state: link
    owner: deploy
    group: deploy

- name: Verify age key permissions
  file:
    path: /opt/hill90/secrets/keys/keys.txt
    owner: deploy
    group: deploy
    mode: '0600'

- name: Display age key transfer status
  debug:
    msg:
      - "Age encryption key successfully transferred to VPS"
      - "Key location: /opt/hill90/secrets/keys/keys.txt"
      - "Symlink created: /opt/hill90/app/infra/secrets/keys/age-prod.key"
