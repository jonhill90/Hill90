---
# Secrets Setup Playbook
# Installs SOPS and age for secrets management

- name: Create secrets directory
  file:
    path: "{{ age_key_path }}"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0700'

- name: Download SOPS binary
  get_url:
    url: "https://github.com/getsops/sops/releases/download/v{{ sops_version }}/sops-v{{ sops_version }}.linux.amd64"
    dest: /usr/local/bin/sops
    mode: '0755'

- name: Verify SOPS installation
  command: sops --version
  register: sops_version_check
  changed_when: false

- name: Display SOPS version
  debug:
    msg: "SOPS installed: {{ sops_version_check.stdout }}"

- name: Download age binary
  get_url:
    url: "https://github.com/FiloSottile/age/releases/download/v{{ age_version }}/age-v{{ age_version }}-linux-amd64.tar.gz"
    dest: /tmp/age.tar.gz

- name: Extract age binary
  unarchive:
    src: /tmp/age.tar.gz
    dest: /tmp
    remote_src: yes

- name: Install age binaries
  copy:
    src: "/tmp/age/{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    mode: '0755'
    remote_src: yes
  loop:
    - age
    - age-keygen

- name: Clean up age download
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/age.tar.gz
    - /tmp/age

- name: Verify age installation
  command: age --version
  register: age_version_check
  changed_when: false

- name: Display age version
  debug:
    msg: "age installed: {{ age_version_check.stdout }}"

- name: Display secrets setup completion
  debug:
    msg:
      - "Secrets infrastructure setup complete!"
      - "age keys directory: {{ age_key_path }}"
      - "Generate age key with: age-keygen -o {{ age_key_path }}/age-prod.key"
      - "Then configure SOPS in infra/secrets/.sops.yaml"
