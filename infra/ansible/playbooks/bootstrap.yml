---
# Hill90 VPS Bootstrap Playbook
# This playbook sets up a fresh AlmaLinux VPS for Hill90 deployment

- name: Bootstrap Hill90 VPS
  hosts: vps
  become: yes
  gather_facts: yes

  vars_files:
    - ../inventory/group_vars/all.yml

  pre_tasks:
    - name: Display bootstrap start message
      debug:
        msg: "Starting Hill90 VPS bootstrap for {{ inventory_hostname }}"

  tasks:
    - name: Import user setup playbook
      import_tasks: 01-user-setup.yml

    - name: Import Docker installation playbook
      import_tasks: 02-docker-install.yml

    - name: Import firewall configuration playbook
      import_tasks: 03-firewall.yml

    - name: Import SSH hardening playbook
      import_tasks: 04-ssh-hardening.yml

    - name: Import secrets setup playbook
      import_tasks: 06-secrets-setup.yml

    - name: Import git and repository setup
      import_tasks: 07-git-and-repo.yml

  post_tasks:
    - name: Display bootstrap completion message
      debug:
        msg: "Hill90 VPS bootstrap completed successfully!"

    - name: Display next steps
      debug:
        msg:
          - "Bootstrap completed! Next steps:"
          - "1. Transfer age key to VPS: scp ~/.config/sops/age/keys.txt deploy@<vps>:{{ age_key_path }}/keys.txt"
          - "2. Configure DNS records for api.hill90.com, ai.hill90.com, hill90.com"
          - "3. Run: make deploy"

  handlers:
    - name: restart docker
      systemd:
        name: docker
        state: restarted

    - name: restart sshd
      systemd:
        name: sshd
        state: restarted

    - name: restart fail2ban
      systemd:
        name: fail2ban
        state: restarted
