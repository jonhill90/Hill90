---
# Master Bootstrap Playbook
# Runs all numbered playbooks in sequence (01-09)
# Based on working bootstrap-v2.yml logic

- name: Bootstrap VPS Infrastructure
  hosts: vps
  become: yes
  gather_facts: yes

  vars_files:
    - ../inventory/group_vars/all.yml

  vars:
    sops_version: "3.8.1"
    age_version: "1.1.1"

  tasks:
    - name: "01 - System Preparation"
      import_tasks: 01-system-prep.yml

    - name: "02 - Firewall"
      import_tasks: 02-firewall.yml

    - name: "03 - Tailscale"
      import_tasks: 03-tailscale.yml

    - name: "04 - SSH Lockdown"
      import_tasks: 04-ssh-lockdown.yml

    - name: "05 - Docker"
      import_tasks: 05-docker.yml

    - name: "06 - SOPS"
      import_tasks: 06-sops.yml

    - name: "07 - Age"
      import_tasks: 07-age.yml

    - name: "08 - Secrets"
      import_tasks: 08-secrets.yml

    # NOTE: Playbooks 09-traefik.yml and 10-portainer.yml are NOT run during bootstrap
    # Infrastructure containers (Traefik, dns-manager, Portainer) are deployed separately
    # via: make deploy-infra

  handlers:
    - name: restart docker
      systemd:
        name: docker
        state: restarted

    - name: restart sshd
      systemd:
        name: sshd
        state: restarted

    - name: restart fail2ban
      systemd:
        name: fail2ban
        state: restarted
