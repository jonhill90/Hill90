---
# Hill90 VPS Bootstrap Playbook
# This playbook sets up a fresh AlmaLinux VPS for Hill90 deployment

- name: Bootstrap Hill90 VPS
  hosts: vps
  become: yes
  gather_facts: yes

  vars_files:
    - ../inventory/group_vars/all.yml

  pre_tasks:
    - name: Display bootstrap start message
      debug:
        msg: "Starting Hill90 VPS bootstrap for {{ inventory_hostname }}"

  tasks:
    # Phase 1: Base System Setup
    - name: Import user setup playbook
      import_tasks: 01-user-setup.yml

    # Phase 2: Network Security (establish VPN access)
    - name: Import basic firewall configuration playbook
      import_tasks: 02-firewall-basic.yml

    - name: Import Tailscale installation playbook
      import_tasks: 03-tailscale.yml

    - name: Import SSH lockdown playbook
      import_tasks: 04-ssh-lockdown.yml

    - name: Import SSH hardening playbook
      import_tasks: 05-ssh-hardening.yml

    # Phase 3: Development Tools
    - name: Import secrets setup playbook
      import_tasks: 06-secrets-setup.yml

    - name: Import git and repository setup
      import_tasks: 07-git-and-repo.yml

    - name: Import age key transfer playbook
      import_tasks: 08-age-key-transfer.yml

    # Phase 4: Application Runtime (LAST)
    - name: Import Docker installation playbook
      import_tasks: 09-docker-install.yml

  post_tasks:
    - name: Display bootstrap completion message
      debug:
        msg: "Hill90 VPS bootstrap completed successfully!"

    - name: Display next steps
      debug:
        msg:
          - "Bootstrap completed! Next steps:"
          - "1. Configure DNS records for api.hill90.com, ai.hill90.com, hill90.com (if not done)"
          - "2. Deploy services: make deploy"
          - "3. Verify health: make health"

  handlers:
    - name: restart docker
      systemd:
        name: docker
        state: restarted

    - name: restart sshd
      systemd:
        name: sshd
        state: restarted

    - name: restart fail2ban
      systemd:
        name: fail2ban
        state: restarted
