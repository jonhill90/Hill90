---
# Firewall Configuration Playbook
# Configures firewalld with secure rules

- name: Install firewalld
  dnf:
    name: firewalld
    state: present

- name: Enable and start firewalld
  systemd:
    name: firewalld
    enabled: yes
    state: started

- name: Configure firewall allowed ports
  firewalld:
    port: "{{ item }}"
    permanent: yes
    state: enabled
    immediate: yes
  loop: "{{ firewall_allowed_ports }}"

- name: Allow Tailscale subnet (100.64.0.0/10)
  firewalld:
    source: 100.64.0.0/10
    zone: trusted
    permanent: yes
    state: enabled
    immediate: yes

- name: Enable rate limiting for SSH
  command: >
    firewall-cmd --permanent --add-rich-rule='rule family="ipv4"
    port protocol="tcp" port="22" limit value="10/m" accept'
  changed_when: false

- name: Reload firewalld
  command: firewall-cmd --reload
  changed_when: false

- name: Display firewall status
  command: firewall-cmd --list-all
  register: firewall_status
  changed_when: false

- name: Show firewall configuration
  debug:
    var: firewall_status.stdout_lines
