---
# SSH Lockdown Playbook
# Locks SSH access to Tailscale network only (after Tailscale is configured)

- name: Remove SSH from public access (Tailscale only)
  firewalld:
    service: ssh
    permanent: yes
    state: disabled
    immediate: yes

- name: Allow SSH from Tailscale network only
  firewalld:
    rich_rule: 'rule family="ipv4" source address="100.64.0.0/10" port port="22" protocol="tcp" accept'
    permanent: yes
    state: enabled
    immediate: yes

- name: Remove obsolete Docker network SSH rules (from Twingate)
  firewalld:
    rich_rule: "{{ item }}"
    permanent: yes
    state: disabled
    immediate: yes
  loop:
    - 'rule family="ipv4" source address="172.17.0.0/16" port port="22" protocol="tcp" accept'
    - 'rule family="ipv4" source address="172.18.0.0/16" port port="22" protocol="tcp" accept'
  ignore_errors: yes

- name: Reload firewalld
  command: firewall-cmd --reload
  changed_when: false

- name: Display firewall status
  command: firewall-cmd --list-all
  register: firewall_status
  changed_when: false

- name: Show SSH lockdown status
  debug:
    msg:
      - "SSH is now locked to Tailscale network only (100.64.0.0/10)"
      - "Public SSH access is BLOCKED"
      - "You must use Tailscale IP for SSH access"

- name: Show firewall configuration
  debug:
    var: firewall_status.stdout_lines
