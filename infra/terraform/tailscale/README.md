# Tailscale Terraform Configuration

This Terraform module manages Hill90's Tailscale configuration for secure VPS access.

## Purpose

- **Generate pre-authorized auth keys** for the VPS to join the Tailscale network
- **Manage ACL policies** (optional, can use Tailscale admin console instead)
- **Enable SSH access** via Tailscale network

## Usage

### 1. Initialize Terraform

```bash
cd infra/terraform/tailscale
terraform init
```

### 2. Configure Variables

Create `terraform.tfvars` from the example:

```bash
cp terraform.tfvars.example terraform.tfvars
```

Edit `terraform.tfvars` with your Tailscale credentials:

```hcl
tailscale_api_key  = "tskey-api-xxxxx"  # Get from Tailscale admin console
tailscale_tailnet  = "example.ts.net"    # Your tailnet name
vps_hostname       = "hill90-vps"
enable_ssh         = true
enable_accept_routes = true
```

### 3. Plan and Apply

```bash
terraform plan
terraform apply
```

### 4. Get the Auth Key

The auth key is output as `vps_auth_key` (marked as sensitive). To retrieve it:

```bash
terraform output -raw vps_auth_key
```

This key is used by the VPS to join the Tailscale network during bootstrap.

## Integration with VPS Bootstrap

The Ansible playbook (05-tailscale.yml) will use the auth key generated by this module:

1. Terraform generates the auth key
2. Auth key is stored in encrypted secrets (`TAILSCALE_AUTH_KEY`)
3. Bootstrap script exports `TAILSCALE_AUTH_KEY` environment variable
4. Ansible playbook reads the variable and uses it to join the tailnet

## Outputs

- `vps_auth_key` (sensitive): Pre-authorized key for VPS
- `auth_key_id`: ID of the auth key
- `auth_key_expiry`: When the auth key expires (90 days)

## Security Notes

- Auth keys are **sensitive** - never commit them to git
- Auth keys expire after 90 days - regenerate by running `terraform apply`
- Use pre-authorized keys to avoid manual device approval
- Consider using ACL tags for fine-grained access control

## Managing ACLs

By default, this module does NOT manage Tailscale ACLs. You can:

1. **Use Tailscale admin console** (recommended for simple setups)
2. **Uncomment the `tailscale_acl` resource** in main.tf to manage via Terraform

Note: The `tailscale_acl` resource replaces the ENTIRE ACL, so be careful!
