# Tailscale Management Reference

## Automated Auth Key Generation

Tailscale auth keys are **automatically generated and rotated** during VPS rebuild:

```bash
# Auth key is automatically generated during rebuild
make recreate-vps
# This command:
# 1. Calls Tailscale API to generate new pre-authorized auth key (90-day expiry)
# 2. Stores it in encrypted secrets automatically
# DONE! No manual Tailscale setup needed.
```

**Auth key expiry:** 90 days (7776000 seconds)

## Manual Auth Key Rotation (if needed)

If you need to rotate the auth key outside of a rebuild:

```bash
# Generate new auth key via API
bash scripts/tailscale-api.sh generate-key

# Update secrets
make secrets-update KEY=TAILSCALE_AUTH_KEY VALUE="<new_key>"
```

## VPS Installation (Automated via Ansible)

The bootstrap process automatically:
1. Installs Tailscale binary (via Ansible playbook 03-tailscale.yml)
2. Joins Tailscale network using auth key from secrets
3. Saves Tailscale IP to `/opt/hill90/.tailscale_ip`
4. Displays Tailscale IP during Ansible run
5. Configures firewall to allow SSH from Tailscale network only (100.64.0.0/10)
6. Locks down SSH to Tailscale-only access

## SSH via Tailscale

```bash
# Get current Tailscale IP from secrets
make secrets-view KEY=TAILSCALE_IP

# SSH via Tailscale IP (REQUIRED - public SSH is blocked)
ssh -i ~/.ssh/remote.hill90.com deploy@<tailscale-ip>

# Or use make ssh (auto-uses Tailscale IP from secrets)
make ssh
```

**Important**: Public SSH on port 22 is **BLOCKED** by firewall. You MUST use Tailscale IP for SSH access.

## Tailscale Configuration

- **Auth key:** Generated by API during `make recreate-vps`, expires in 90 days
- **API key:** Stored in `infra/secrets/prod.enc.env` as `TAILSCALE_API_KEY`
- **Firewall:** SSH allowed only from Tailscale CGNAT range (100.64.0.0/10)
- **Hostname:** `hill90-vps` (configured in Ansible)
- **Current Tailscale IP:** Retrieved from VPS and stored in secrets automatically

## Troubleshooting

### Cannot SSH to VPS

1. Verify Tailscale is running on your Mac:
   ```bash
   tailscale status
   ```

2. Verify VPS joined Tailscale network:
   - Check Tailscale admin console at https://login.tailscale.com/admin/machines
   - Look for device named `hill90-vps`

3. Get Tailscale IP from VPS (within first few minutes before SSH lockdown):
   ```bash
   ssh -i ~/.ssh/remote.hill90.com root@<public-ip> 'cat /opt/hill90/.tailscale_ip'
   ```

4. Update secrets with correct Tailscale IP:
   ```bash
   make secrets-update KEY=TAILSCALE_IP VALUE="<ip>"
   ```

### Auth Key Expired

Auth keys expire after 90 days. Rebuild VPS to generate new key:

```bash
make recreate-vps
# New auth key generated automatically
```

### Manual API Operations

```bash
# Generate new auth key
bash scripts/tailscale-api.sh generate-key

# View current API key
make secrets-view KEY=TAILSCALE_API_KEY
```

## Key Files

- `scripts/tailscale-api.sh` - Tailscale API client (auth key generation)
- `infra/ansible/playbooks/03-tailscale.yml` - Tailscale installation and configuration
- `infra/secrets/prod.enc.env` - Encrypted secrets (TAILSCALE_AUTH_KEY, TAILSCALE_IP, TAILSCALE_API_KEY)
