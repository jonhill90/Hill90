# Tailscale Management Reference

## Automated Auth Key Generation

Tailscale auth keys are **automatically generated and rotated** during VPS rebuild:

```bash
# Auth key is automatically generated during rebuild
make recreate-vps
# This command:
# 1. Calls Tailscale API to generate new pre-authorized auth key (90-day expiry)
# 2. Stores it in encrypted secrets automatically
# DONE! No manual Tailscale setup needed.
```

**Auth key expiry:** 90 days (7776000 seconds)

## Manual Auth Key Rotation (if needed)

If you need to rotate the auth key outside of a rebuild:

```bash
# Generate new auth key via API
bash scripts/tailscale-api.sh generate-key

# Update secrets
make secrets-update KEY=TAILSCALE_AUTH_KEY VALUE="<new_key>"
```

## VPS Installation (Automated via Ansible)

The bootstrap process automatically:
1. Installs Tailscale binary (via Ansible playbook 03-tailscale.yml)
2. Joins Tailscale network using auth key from secrets
3. Saves Tailscale IP to `/opt/hill90/.tailscale_ip`
4. Displays Tailscale IP during Ansible run
5. Configures firewall to allow SSH from Tailscale network only (100.64.0.0/10)
6. Locks down SSH to Tailscale-only access

## Tailscale ACL GitOps Workflow

**Tailscale ACL policies are managed via GitOps** - changes are automatically deployed when pushed to main.

### How It Works

1. Edit `policy.hujson` in repository root
2. Commit and push to main branch
3. GitHub Actions workflow (`.github/workflows/tailscale.yml`) automatically:
   - Validates ACL syntax
   - Deploys to Tailscale network
   - Updates live policy immediately

### Pull Request Testing

When creating a PR that modifies `policy.hujson`:
- ACL is automatically **tested** for syntax errors
- Invalid ACLs will fail the PR check
- Merge only after ACL test passes

### Policy File Location

- **File:** `policy.hujson` (repository root)
- **Format:** JSON with comments (HuJSON)
- **Manages:**
  - Tag ownership (`tagOwners`)
  - Network access grants (`grants`)
  - SSH access rules (`ssh`)

### Example: Admin SSH Access

To allow admin users to SSH to VPS, add to `policy.hujson`:

```json
"ssh": [
  {
    "action": "accept",
    "src":    ["autogroup:admin"],
    "dst":    ["tag:vps"],
    "users":  ["root", "deploy", "autogroup:nonroot"],
  }
]
```

Push to main â†’ ACL deployed automatically.

## ACL Configuration for SSH Access

**Required ACL rules for admin SSH access:**

The VPS must have the `tag:vps` tag, and your user must be in `autogroup:admin` or have explicit SSH access configured.

**Current policy includes:**

1. **Admin SSH access:**
   ```json
   {
     "action": "accept",
     "src":    ["autogroup:admin"],
     "dst":    ["tag:vps"],
     "users":  ["root", "deploy", "autogroup:nonroot"],
   }
   ```

2. **GitHub Actions runner access:**
   ```json
   {
     "action": "accept",
     "src":    ["tag:github-actions"],
     "dst":    ["tag:vps"],
     "users":  ["root", "deploy", "autogroup:nonroot"],
   }
   ```

**To check your access:**
- Visit Tailscale admin console: https://login.tailscale.com/admin/acls
- Verify your user is in `autogroup:admin`
- Verify VPS device has `tag:vps` tag

## SSH via Tailscale

```bash
# Get current Tailscale IP from secrets
make secrets-view KEY=TAILSCALE_IP

# SSH via Tailscale IP (REQUIRED - public SSH is blocked)
ssh -i ~/.ssh/remote.hill90.com deploy@<tailscale-ip>

# Or use make ssh (auto-uses Tailscale IP from secrets)
make ssh
```

**Important**: Public SSH on port 22 is **BLOCKED** by firewall. You MUST use Tailscale IP for SSH access.

## Tailscale Configuration

- **Auth key:** Generated by API during `make recreate-vps`, expires in 90 days
- **API key:** Stored in `infra/secrets/prod.enc.env` as `TAILSCALE_API_KEY`
- **Firewall:** SSH allowed only from Tailscale CGNAT range (100.64.0.0/10)
- **Hostname:** `hill90-vps` (configured in Ansible)
- **Current Tailscale IP:** Retrieved from VPS and stored in secrets automatically

## Troubleshooting

### Cannot SSH to VPS

1. **Check ACL rules first:**
   - Visit Tailscale admin console: https://login.tailscale.com/admin/acls
   - Verify ACL includes admin SSH rule (see "ACL Configuration for SSH Access" above)
   - Verify your user is in `autogroup:admin`
   - Verify VPS device has `tag:vps` tag

2. Verify Tailscale is running on your Mac:
   ```bash
   tailscale status
   ```

3. Verify VPS joined Tailscale network:
   - Check Tailscale admin console at https://login.tailscale.com/admin/machines
   - Look for device named `hill90-vps`

4. Get Tailscale IP from VPS (within first few minutes before SSH lockdown):
   ```bash
   ssh -i ~/.ssh/remote.hill90.com root@<public-ip> 'cat /opt/hill90/.tailscale_ip'
   ```

5. Update secrets with correct Tailscale IP:
   ```bash
   make secrets-update KEY=TAILSCALE_IP VALUE="<ip>"
   ```

### Auth Key Expired

Auth keys expire after 90 days. Rebuild VPS to generate new key:

```bash
make recreate-vps
# New auth key generated automatically
```

### Manual API Operations

```bash
# Generate new auth key
bash scripts/tailscale-api.sh generate-key

# View current API key
make secrets-view KEY=TAILSCALE_API_KEY
```

## Key Files

- `scripts/tailscale-api.sh` - Tailscale API client (auth key generation)
- `infra/ansible/playbooks/03-tailscale.yml` - Tailscale installation and configuration
- `infra/secrets/prod.enc.env` - Encrypted secrets (TAILSCALE_AUTH_KEY, TAILSCALE_IP, TAILSCALE_API_KEY)
