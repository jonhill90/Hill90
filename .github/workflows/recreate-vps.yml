name: VPS Recreate (Automated)

# Manual trigger only - DESTRUCTIVE operation
on:
  workflow_dispatch:
    inputs:
      confirm_recreate:
        description: 'Type RECREATE to confirm VPS recreate (DESTRUCTIVE)'
        required: true
        type: string

jobs:
  recreate:
    name: Recreate VPS via Hostinger API
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: write

    steps:
      # ========================================
      # 1. VALIDATION
      # ========================================
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_recreate }}" != "RECREATE" ]; then
            echo "‚ùå Recreate not confirmed. You must type 'RECREATE' exactly."
            exit 1
          fi
          echo "‚úÖ Recreate confirmed - proceeding with VPS recreate"

      # ========================================
      # 2. SETUP
      # ========================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible jq curl

          # Install SOPS from GitHub releases
          SOPS_VERSION="3.9.0"
          curl -Lo /tmp/sops "https://github.com/getsops/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.amd64"
          chmod +x /tmp/sops
          sudo mv /tmp/sops /usr/local/bin/sops
          sops --version

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-actions

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/remote.hill90.com
          chmod 600 ~/.ssh/remote.hill90.com

      - name: Setup SOPS/age key
        run: |
          mkdir -p ~/.config/sops/age
          echo "${{ secrets.SOPS_AGE_KEY }}" > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt

      # ========================================
      # 3. RECREATE VPS (via make command)
      # ========================================
      - name: Run make recreate-vps
        env:
          HOSTINGER_API_KEY: ${{ secrets.HOSTINGER_API_KEY }}
          TAILSCALE_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
          TAILSCALE_TAILNET: ${{ secrets.TAILSCALE_TAILNET }}
          SOPS_AGE_KEY_FILE: /home/runner/.config/sops/age/keys.txt
        run: |
          echo "üîÑ Running VPS recreate via make recreate-vps..."
          make recreate-vps

      - name: Capture new VPS IP from secrets
        id: get-vps-ip
        run: |
          echo "üåê Reading VPS IP from encrypted secrets..."
          VPS_IP=$(sops -d --extract '["VPS_IP"]' infra/secrets/prod.enc.env)
          echo "::add-mask::$VPS_IP"
          echo "vps_ip=$VPS_IP" >> $GITHUB_OUTPUT
          echo "New VPS IP: $VPS_IP"

      - name: Wait for SSH to be available
        run: |
          echo "‚è≥ Waiting for SSH to be available on ${{ steps.get-vps-ip.outputs.vps_ip }}..."
          for i in {1..30}; do
            if ssh -i ~/.ssh/remote.hill90.com -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
                root@${{ steps.get-vps-ip.outputs.vps_ip }} 'echo "SSH ready"' 2>/dev/null; then
              echo "‚úÖ SSH is ready"
              break
            fi
            echo "Attempt $i/30 failed, waiting 10s..."
            sleep 10
          done

      # ========================================
      # 4. BOOTSTRAP VPS (via make command)
      # ========================================
      - name: Capture Tailscale auth key from secrets
        id: get-tailscale-auth-key
        run: |
          echo "üîë Reading Tailscale auth key from encrypted secrets..."
          TAILSCALE_AUTH_KEY=$(sops -d --extract '["TAILSCALE_AUTH_KEY"]' infra/secrets/prod.enc.env)
          echo "::add-mask::$TAILSCALE_AUTH_KEY"
          echo "tailscale_auth_key=$TAILSCALE_AUTH_KEY" >> $GITHUB_OUTPUT

      - name: Create age key file for Ansible
        run: |
          echo "üîê Creating age key file for Ansible..."
          mkdir -p infra/secrets/keys
          echo "${{ secrets.SOPS_AGE_KEY }}" > infra/secrets/keys/age-prod.key
          chmod 600 infra/secrets/keys/age-prod.key

      - name: Run make config-vps
        env:
          VPS_IP: ${{ steps.get-vps-ip.outputs.vps_ip }}
          TAILSCALE_AUTH_KEY: ${{ steps.get-tailscale-auth-key.outputs.tailscale_auth_key }}
          SOPS_AGE_KEY_FILE: /home/runner/.config/sops/age/keys.txt
        run: |
          echo "üîß Running VPS bootstrap via make config-vps..."
          make config-vps VPS_IP=$VPS_IP

      - name: Capture Tailscale IP from secrets
        id: get-tailscale-ip
        run: |
          echo "üåê Reading Tailscale IP from encrypted secrets..."
          TAILSCALE_IP=$(sops -d --extract '["TAILSCALE_IP"]' infra/secrets/prod.enc.env)
          echo "::add-mask::$TAILSCALE_IP"
          echo "tailscale_ip=$TAILSCALE_IP" >> $GITHUB_OUTPUT
          echo "Tailscale IP: $TAILSCALE_IP"

      # ========================================
      # 5. DEPLOY SERVICES
      # ========================================
      - name: Deploy services via SSH
        run: |
          echo "üöÄ Deploying services to VPS..."
          ssh -i ~/.ssh/remote.hill90.com -o StrictHostKeyChecking=no \
            deploy@${{ steps.get-tailscale-ip.outputs.tailscale_ip }} \
            'cd /opt/hill90/app && \
             export SOPS_AGE_KEY_FILE=/opt/hill90/secrets/keys/keys.txt && \
             bash scripts/deploy.sh prod'

      - name: Wait for services to start
        run: |
          echo "‚è≥ Waiting for services to start (60 seconds)..."
          sleep 60

      - name: Verify service health
        run: |
          echo "üè• Verifying service health..."
          ssh -i ~/.ssh/remote.hill90.com -o StrictHostKeyChecking=no \
            deploy@${{ steps.get-tailscale-ip.outputs.tailscale_ip }} \
            'docker ps --format "table {{.Names}}\t{{.Status}}"'

      # ========================================
      # 6. COMMIT UPDATED SECRETS
      # ========================================
      - name: Commit updated secrets
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add infra/secrets/prod.enc.env
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update VPS IPs after recreate

            - VPS Public IP: ${{ steps.get-vps-ip.outputs.vps_ip }}
            - Tailscale IP: ${{ steps.get-tailscale-ip.outputs.tailscale_ip }}
            - Recreate action: ${{ github.run_id }}"
            git push
          fi

      # ========================================
      # 7. CLEANUP
      # ========================================
      - name: Cleanup backup files
        if: always()
        run: |
          find infra/secrets -name "*.backup.*" -type f -delete || true

      # ========================================
      # 8. SUMMARY
      # ========================================
      - name: Print summary
        if: success()
        run: |
          echo "üéâ VPS recreate complete!"
          echo ""
          echo "üìä New VPS details:"
          echo "  Public IP: ${{ steps.get-vps-ip.outputs.vps_ip }}"
          echo "  Tailscale IP: ${{ steps.get-tailscale-ip.outputs.tailscale_ip }}"
          echo ""
          echo "‚úÖ Next steps:"
          echo "  1. Verify services: make health"
          echo "  2. SSH via Tailscale: make ssh"
          echo "  3. Check logs: make logs"
