name: VPS Recreate (Infrastructure Only)

# Manual trigger only - DESTRUCTIVE operation
# Rebuilds VPS and bootstraps infrastructure (Docker, Tailscale, firewall)
# Does NOT deploy application - use Deploy workflows separately
on:
  workflow_dispatch:
    inputs:
      confirm_recreate:
        description: 'Type RECREATE to confirm VPS recreate (DESTRUCTIVE)'
        required: true
        type: string

jobs:
  recreate:
    name: Recreate VPS via Hostinger API
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: write

    steps:
      # ========================================
      # 1. VALIDATION
      # ========================================
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_recreate }}" != "RECREATE" ]; then
            echo "‚ùå Recreate not confirmed. You must type 'RECREATE' exactly."
            exit 1
          fi
          echo "‚úÖ Recreate confirmed - proceeding with VPS recreate"

      # ========================================
      # 2. SETUP
      # ========================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible jq curl

          # Install SOPS from GitHub releases
          SOPS_VERSION="3.9.0"
          curl -Lo /tmp/sops "https://github.com/getsops/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.amd64"
          chmod +x /tmp/sops
          sudo mv /tmp/sops /usr/local/bin/sops
          sops --version

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-actions

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/remote.hill90.com
          chmod 600 ~/.ssh/remote.hill90.com

      - name: Setup SOPS/age key
        run: |
          mkdir -p ~/.config/sops/age
          echo "${{ secrets.SOPS_AGE_KEY }}" > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt

      # ========================================
      # 3. RECREATE VPS (via make command)
      # ========================================
      - name: Run make recreate-vps
        env:
          HOSTINGER_API_KEY: ${{ secrets.HOSTINGER_API_KEY }}
          TAILSCALE_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
          TAILSCALE_TAILNET: ${{ secrets.TAILSCALE_TAILNET }}
          SOPS_AGE_KEY_FILE: /home/runner/.config/sops/age/keys.txt
        run: |
          echo "üîÑ Running VPS recreate via make recreate-vps..."
          make recreate-vps

      - name: Capture new VPS IP from secrets
        id: get-vps-ip
        run: |
          echo "üåê Reading VPS IP from encrypted secrets..."
          VPS_IP=$(sops -d --extract '["VPS_IP"]' infra/secrets/prod.enc.env)
          echo "::add-mask::$VPS_IP"
          echo "vps_ip=$VPS_IP" >> $GITHUB_OUTPUT
          echo "New VPS IP: $VPS_IP"

      - name: Wait for SSH to be available
        run: |
          echo "‚è≥ Waiting for SSH to be available on ${{ steps.get-vps-ip.outputs.vps_ip }}..."
          for i in {1..30}; do
            if ssh -i ~/.ssh/remote.hill90.com -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
                root@${{ steps.get-vps-ip.outputs.vps_ip }} 'echo "SSH ready"' 2>/dev/null; then
              echo "‚úÖ SSH is ready"
              break
            fi
            echo "Attempt $i/30 failed, waiting 10s..."
            sleep 10
          done

      - name: Install Ansible
        run: |
          # Already installed in dependencies step

      - name: Export secrets for Ansible
        run: |
          TAILSCALE_AUTH_KEY=$(sops -d --extract '["TAILSCALE_AUTH_KEY"]' infra/secrets/prod.enc.env)
          TRAEFIK_ADMIN_PASSWORD_HASH=$(sops -d --extract '["TRAEFIK_ADMIN_PASSWORD_HASH"]' infra/secrets/prod.enc.env)
          HOSTINGER_API_KEY=$(sops -d --extract '["HOSTINGER_API_KEY"]' infra/secrets/prod.enc.env)

          echo "::add-mask::$TAILSCALE_AUTH_KEY"
          echo "::add-mask::$TRAEFIK_ADMIN_PASSWORD_HASH"
          echo "::add-mask::$HOSTINGER_API_KEY"

          echo "TAILSCALE_AUTH_KEY=$TAILSCALE_AUTH_KEY" >> $GITHUB_ENV
          echo "TRAEFIK_ADMIN_PASSWORD_HASH=$TRAEFIK_ADMIN_PASSWORD_HASH" >> $GITHUB_ENV
          echo "HOSTINGER_API_KEY=$HOSTINGER_API_KEY" >> $GITHUB_ENV

      - name: Run Ansible bootstrap
        env:
          SOPS_AGE_KEY_FILE: /home/runner/.config/sops/age/keys.txt
        run: |
          echo "üöÄ Running Ansible bootstrap immediately after rebuild..."
          VPS_IP="${{ steps.get-vps-ip.outputs.vps_ip }}"

          # Read age key from secret for transfer to VPS
          AGE_KEY_CONTENT=$(cat ~/.config/sops/age/keys.txt)

          cd infra/ansible
          ansible-playbook -i "inventory/hosts.yml" \
            -e "ansible_host=$VPS_IP" \
            -e "ansible_user=root" \
            -e "ansible_ssh_private_key_file=~/.ssh/remote.hill90.com" \
            -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'" \
            -e "traefik_admin_password_hash=$TRAEFIK_ADMIN_PASSWORD_HASH" \
            -e "hostinger_api_key=$HOSTINGER_API_KEY" \
            -e "age_key_content=$AGE_KEY_CONTENT" \
            playbooks/bootstrap.yml

      - name: Extract Tailscale IP
        id: get-tailscale-ip
        run: |
          echo "üåê Waiting for Tailscale connection..."
          sleep 30

          # After bootstrap, SSH is locked to Tailscale network only
          # VPS hostname on Tailscale: hill90-vps
          # Ansible playbook saves Tailscale IP to /opt/hill90/.tailscale_ip
          echo "Reading Tailscale IP from VPS..."

          # Try tailscale command first
          if command -v tailscale &> /dev/null; then
            TAILSCALE_IP=$(tailscale ip hill90-vps 2>/dev/null || echo "")
            [ -n "$TAILSCALE_IP" ] && echo "Got IP via tailscale command: $TAILSCALE_IP"
          fi

          # Fallback: SSH as deploy user via Tailscale hostname and read saved IP file
          if [ -z "$TAILSCALE_IP" ]; then
            echo "Trying SSH as deploy@hill90-vps via Tailscale..."
            TAILSCALE_IP=$(ssh -i ~/.ssh/remote.hill90.com -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
              deploy@hill90-vps 'cat /opt/hill90/.tailscale_ip' 2>/dev/null || echo "")
            [ -n "$TAILSCALE_IP" ] && echo "Got IP via SSH to Tailscale hostname"
          fi

          if [ -z "$TAILSCALE_IP" ]; then
            echo "‚ùå Failed to get Tailscale IP"
            echo "   VPS may not have joined Tailscale network"
            echo "   Check Tailscale status on VPS"
            exit 1
          fi

          echo "::add-mask::$TAILSCALE_IP"
          echo "tailscale_ip=$TAILSCALE_IP" >> $GITHUB_OUTPUT
          echo "‚úÖ Tailscale IP: $TAILSCALE_IP"

      - name: Update TAILSCALE_IP in secrets
        run: |
          echo "üìù Updating TAILSCALE_IP in encrypted secrets..."
          TAILSCALE_IP="${{ steps.get-tailscale-ip.outputs.tailscale_ip }}"

          # Create temporary script to update secrets
          cat > /tmp/update-secret.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail
          KEY="$1"
          VALUE="$2"
          SECRETS_FILE="infra/secrets/prod.enc.env"

          # Decrypt, update, re-encrypt
          sops -d "$SECRETS_FILE" > /tmp/secrets.env
          if grep -q "^${KEY}=" /tmp/secrets.env; then
            sed -i "s|^${KEY}=.*|${KEY}=${VALUE}|" /tmp/secrets.env
          else
            echo "${KEY}=${VALUE}" >> /tmp/secrets.env
          fi
          sops -e /tmp/secrets.env > "$SECRETS_FILE"
          rm /tmp/secrets.env
          EOF

          chmod +x /tmp/update-secret.sh
          /tmp/update-secret.sh TAILSCALE_IP "$TAILSCALE_IP"

          echo "‚úÖ TAILSCALE_IP updated"

      - name: Verify infrastructure
        run: |
          echo "üè• Verifying infrastructure..."
          TAILSCALE_IP="${{ steps.get-tailscale-ip.outputs.tailscale_ip }}"

          # Check Docker is running
          ssh -i ~/.ssh/remote.hill90.com -o StrictHostKeyChecking=no \
            deploy@$TAILSCALE_IP 'docker --version'

          # Check Traefik is running
          ssh -i ~/.ssh/remote.hill90.com -o StrictHostKeyChecking=no \
            deploy@$TAILSCALE_IP 'docker ps | grep traefik'

          # Check Portainer is running
          ssh -i ~/.ssh/remote.hill90.com -o StrictHostKeyChecking=no \
            deploy@$TAILSCALE_IP 'docker ps | grep portainer'

          echo "‚úÖ All infrastructure services running"

      # ========================================
      # 4. COMMIT UPDATED SECRETS
      # ========================================
      - name: Commit updated secrets
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add infra/secrets/prod.enc.env
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update VPS IPs after recreate and bootstrap

            - VPS Public IP: ${{ steps.get-vps-ip.outputs.vps_ip }}
            - VPS Tailscale IP: ${{ steps.get-tailscale-ip.outputs.tailscale_ip }}
            - Recreate action: ${{ github.run_id }}

            Infrastructure bootstrapped: Docker, Tailscale, Traefik, Portainer"
            git push
          fi

      # ========================================
      # 6. CLEANUP
      # ========================================
      - name: Cleanup backup files
        if: always()
        run: |
          find infra/secrets -name "*.backup.*" -type f -delete || true

      # ========================================
      # 5. SUMMARY
      # ========================================
      - name: Print summary
        if: success()
        run: |
          echo "üéâ VPS recreate and bootstrap complete!"
          echo ""
          echo "üìä VPS details:"
          echo "  Public IP: ${{ steps.get-vps-ip.outputs.vps_ip }}"
          echo "  Tailscale IP: ${{ steps.get-tailscale-ip.outputs.tailscale_ip }}"
          echo ""
          echo "‚úÖ Infrastructure deployed:"
          echo "  ‚Ä¢ Docker + Docker Compose"
          echo "  ‚Ä¢ Tailscale VPN"
          echo "  ‚Ä¢ Traefik reverse proxy (https://traefik.hill90.com)"
          echo "  ‚Ä¢ Portainer container manager (https://portainer.hill90.com)"
          echo "  ‚Ä¢ DNS Manager (for Let's Encrypt DNS-01 challenges)"
          echo ""
          echo "üìã Next steps:"
          echo "  1. Setup Portainer admin: https://portainer.hill90.com (Tailscale-only)"
          echo "  2. Deploy application services: Trigger 'Deploy (Production)' workflow"
          echo "  3. SSH access: ssh -i ~/.ssh/remote.hill90.com deploy@${{ steps.get-tailscale-ip.outputs.tailscale_ip }}"
          echo ""
          echo "üí° Success!"
          echo "  VPS was rebuilt and configured in one atomic operation"
          echo "  No manual steps needed - infrastructure is production-ready"
