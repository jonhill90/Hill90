name: Deploy (Production Certificates)

# ‚ö†Ô∏è  PRODUCTION CERTIFICATES - RATE LIMITED ‚ö†Ô∏è
# Let's Encrypt production: 50 certificates per week
# Use this workflow for main branch deployments only
# For testing, use 'Deploy (Staging)' workflow instead
on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'deployments/**'
      - 'scripts/deploy.sh'
      - 'scripts/build-and-deploy.sh'
      - '.github/workflows/deploy-production.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - prod
        default: 'prod'
      confirm_production:
        description: 'Type PRODUCTION to confirm (rate limited: 50 certs/week)'
        required: true
        type: string

jobs:
  validate-production:
    name: Validate Production Deployment
    runs-on: ubuntu-latest

    steps:
      - name: Validate manual trigger confirmation
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.confirm_production }}" != "PRODUCTION" ]; then
            echo "‚ùå Production deployment not confirmed"
            echo "   You must type 'PRODUCTION' exactly"
            echo "   Rate limit: 50 certificates per week"
            exit 1
          fi
          echo "‚úÖ Production deployment confirmed"

      - name: Rate limit warning
        run: |
          echo "‚ö†Ô∏è  PRODUCTION CERTIFICATE DEPLOYMENT ‚ö†Ô∏è"
          echo ""
          echo "Let's Encrypt Rate Limits:"
          echo "  - 50 certificates per week"
          echo "  - 5 validation failures per hour"
          echo ""
          echo "Proceeding with production certificate deployment..."

  validate:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    needs: validate-production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Docker Compose files
        run: |
          echo "üîç Validating Docker Compose configuration..."

          # Check if docker compose files exist
          if [[ ! -f deployments/docker-compose.prod.yml ]]; then
            echo "‚ùå Missing docker-compose.prod.yml"
            exit 1
          fi

          # Validate syntax (basic check)
          echo "‚úÖ Docker Compose files found"

      - name: Validate deployment scripts
        run: |
          echo "üîç Validating deployment scripts..."

          if [[ ! -f scripts/deploy.sh ]]; then
            echo "‚ùå Missing deploy.sh"
            exit 1
          fi

          if [[ ! -x scripts/deploy.sh ]]; then
            echo "‚ùå deploy.sh is not executable"
            exit 1
          fi

          echo "‚úÖ Deployment scripts validated"

      - name: Validate secrets structure
        run: |
          echo "üîç Validating encrypted secrets file..."

          if [[ ! -f infra/secrets/prod.enc.env ]]; then
            echo "‚ùå Missing prod.enc.env"
            exit 1
          fi

          echo "‚úÖ Secrets file exists (encrypted)"

  deploy:
    name: Deploy Services (Production Certs)
    runs-on: ubuntu-latest
    needs: validate
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:ci

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key

      - name: Setup SOPS/age for secrets
        run: |
          # Install SOPS
          curl -L -o /tmp/sops https://github.com/getsops/sops/releases/download/v3.8.1/sops-v3.8.1.linux.amd64
          chmod +x /tmp/sops
          sudo mv /tmp/sops /usr/local/bin/sops

          # Setup age key
          mkdir -p ~/.config/sops/age
          echo "${{ secrets.SOPS_AGE_KEY }}" > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt

      - name: Get Tailscale IP from secrets
        id: get-ip
        run: |
          echo "üåê Fetching VPS Tailscale IP from encrypted secrets..."
          TAILSCALE_IP=$(sops -d --extract '["TAILSCALE_IP"]' infra/secrets/prod.enc.env)
          echo "::add-mask::$TAILSCALE_IP"
          echo "tailscale_ip=$TAILSCALE_IP" >> $GITHUB_OUTPUT
          echo "Tailscale IP retrieved successfully"

      - name: Verify SSH connectivity
        run: |
          echo "üîå Verifying SSH connectivity to VPS..."
          if ! ssh -i ~/.ssh/vps_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
              deploy@${{ steps.get-ip.outputs.tailscale_ip }} 'echo "SSH connection successful"'; then
            echo "‚ùå Failed to connect to VPS via SSH"
            exit 1
          fi
          echo "‚úÖ SSH connectivity verified"

      - name: Deploy to VPS with production certificates
        run: |
          echo "üöÄ Using Let's Encrypt PRODUCTION certificates"
          echo "   ‚úÖ Trusted by all browsers"
          echo "   ‚ö†Ô∏è  Rate limited: 50 certificates/week"
          echo ""

          # Deploy via SSH with production ACME server
          ssh -i ~/.ssh/vps_key -o StrictHostKeyChecking=no \
            deploy@${{ steps.get-ip.outputs.tailscale_ip }} \
            "cd /opt/hill90/app && \
             git fetch origin && \
             git reset --hard origin/main && \
             export SOPS_AGE_KEY_FILE=/opt/hill90/secrets/keys/keys.txt && \
             export ACME_CA_SERVER=https://acme-v02.api.letsencrypt.org/directory && \
             bash scripts/deploy.sh prod"

      - name: Wait for services to start
        run: |
          echo "‚è≥ Waiting for services to start (60 seconds)..."
          sleep 60

      - name: Verify service health
        run: |
          echo "üè• Verifying service health..."

          # Check Docker containers are running
          ssh -i ~/.ssh/vps_key -o StrictHostKeyChecking=no \
            deploy@${{ steps.get-ip.outputs.tailscale_ip }} \
            'docker ps --format "table {{.Names}}\t{{.Status}}" | grep -E "(api|traefik|auth|postgres)"'

          echo "‚úÖ All services are running"

      - name: Summary
        if: success()
        run: |
          echo "üéâ Deployment complete!"
          echo ""
          echo "üìä Deployment details:"
          echo "  Environment: ${{ github.event.inputs.environment || 'prod' }}"
          echo "  Certificates: PRODUCTION (trusted, rate-limited)"
          echo "  Branch: main"
          echo "  Commit: ${{ github.sha }}"
          echo ""
          echo "‚úÖ Production certificates issued successfully"
          echo "   Certificates are trusted by all browsers"
          echo ""
          echo "‚úÖ Next steps:"
          echo "  1. Verify services: make health"
          echo "  2. Check logs: make logs"
          echo "  3. Test endpoints (no -k flag needed for curl)"

  health-check:
    name: Extended Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:ci

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key

      - name: Setup SOPS for secrets
        run: |
          curl -L -o /tmp/sops https://github.com/getsops/sops/releases/download/v3.8.1/sops-v3.8.1.linux.amd64
          chmod +x /tmp/sops
          sudo mv /tmp/sops /usr/local/bin/sops

          mkdir -p ~/.config/sops/age
          echo "${{ secrets.SOPS_AGE_KEY }}" > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt

      - name: Get Tailscale IP
        id: get-ip
        run: |
          TAILSCALE_IP=$(sops -d --extract '["TAILSCALE_IP"]' infra/secrets/prod.enc.env)
          echo "::add-mask::$TAILSCALE_IP"
          echo "tailscale_ip=$TAILSCALE_IP" >> $GITHUB_OUTPUT

      - name: Check container health
        run: |
          echo "üè• Running extended health checks..."

          # Check all containers are running
          echo "üì¶ Checking container status..."
          ssh -i ~/.ssh/vps_key -o StrictHostKeyChecking=no \
            deploy@${{ steps.get-ip.outputs.tailscale_ip }} \
            'cd /opt/hill90/app && docker compose -f deployments/docker-compose.prod.yml ps'

      - name: Check container logs for errors
        run: |
          echo "üìã Checking recent logs for errors..."

          # Check for recent errors in logs (last 50 lines)
          ssh -i ~/.ssh/vps_key -o StrictHostKeyChecking=no \
            deploy@${{ steps.get-ip.outputs.tailscale_ip }} \
            'cd /opt/hill90/app && docker compose -f deployments/docker-compose.prod.yml logs --tail=50' \
            | grep -i "error\|fatal\|exception" || echo "No errors found in recent logs"

      - name: Verify Traefik dashboard
        run: |
          echo "üåê Checking Traefik dashboard..."

          # Verify Traefik is responding
          ssh -i ~/.ssh/vps_key -o StrictHostKeyChecking=no \
            deploy@${{ steps.get-ip.outputs.tailscale_ip }} \
            'curl -f http://localhost:8080/api/http/routers || echo "‚ö†Ô∏è  Traefik dashboard not responding"'

      - name: Health check summary
        run: |
          echo "‚úÖ Extended health checks complete!"
          echo ""
          echo "All services appear to be healthy."
          echo "Monitor logs for the next few minutes to ensure stability."
