name: VPS Rebuild (Full Automation)

# Manual trigger for VPS rebuild via Hostinger API
# This replaces the MCP-based rebuild process for full GitHub Actions automation
on:
  workflow_dispatch:
    inputs:
      confirm_rebuild:
        description: 'Type "REBUILD" to confirm VPS rebuild (DESTRUCTIVE)'
        required: true
        type: string
      template_id:
        description: 'OS Template ID'
        required: true
        default: '1183'
        type: string
      use_post_install_script:
        description: 'Use post-install script for binary caching?'
        required: true
        type: boolean
        default: true

jobs:
  rebuild:
    name: Rebuild VPS from Scratch
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_rebuild }}" != "REBUILD" ]; then
            echo "‚ùå Rebuild not confirmed. You must type 'REBUILD' exactly."
            exit 1
          fi
          echo "‚úÖ Rebuild confirmed - proceeding with VPS rebuild"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl ansible sshpass

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:ci

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key

      - name: Setup SOPS/age for secrets
        run: |
          # Install SOPS
          curl -L -o /tmp/sops https://github.com/getsops/sops/releases/download/v3.8.1/sops-v3.8.1.linux.amd64
          chmod +x /tmp/sops
          sudo mv /tmp/sops /usr/local/bin/sops

          # Setup age key
          mkdir -p ~/.config/sops/age
          echo "${{ secrets.SOPS_AGE_KEY }}" > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt

      - name: Generate root password
        id: gen-password
        run: |
          PASSWORD=$(openssl rand -base64 32)
          echo "::add-mask::$PASSWORD"
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT

      - name: Generate Tailscale auth key
        id: gen-tailscale-key
        env:
          TAILSCALE_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
          TAILSCALE_TAILNET: ${{ secrets.TAILSCALE_TAILNET }}
        run: |
          # Load secrets to get Tailscale API key
          source scripts/load-secrets.sh

          # Generate auth key via API
          AUTH_KEY=$(bash scripts/tailscale-api.sh generate-key)
          echo "::add-mask::$AUTH_KEY"
          echo "auth_key=$AUTH_KEY" >> $GITHUB_OUTPUT

      - name: Create VPS snapshot (backup)
        id: create-snapshot
        env:
          HOSTINGER_API_KEY: ${{ secrets.HOSTINGER_API_KEY }}
          HOSTINGER_VPS_ID: ${{ secrets.HOSTINGER_VPS_ID }}
        run: |
          echo "üì∏ Creating VPS snapshot as backup before rebuild..."
          RESPONSE=$(bash scripts/hostinger-api.sh snapshot)
          ACTION_ID=$(echo "$RESPONSE" | jq -r '.id')
          echo "snapshot_action_id=$ACTION_ID" >> $GITHUB_OUTPUT
          echo "Snapshot action ID: $ACTION_ID"

      - name: Wait for snapshot to complete
        env:
          HOSTINGER_API_KEY: ${{ secrets.HOSTINGER_API_KEY }}
          HOSTINGER_VPS_ID: ${{ secrets.HOSTINGER_VPS_ID }}
        run: |
          echo "‚è≥ Waiting for snapshot to complete..."
          bash scripts/hostinger-api.sh wait-action ${{ steps.create-snapshot.outputs.snapshot_action_id }} 300

      - name: Recreate VPS OS
        id: recreate-vps
        env:
          HOSTINGER_API_KEY: ${{ secrets.HOSTINGER_API_KEY }}
          HOSTINGER_VPS_ID: ${{ secrets.HOSTINGER_VPS_ID }}
          HOSTINGER_POST_INSTALL_SCRIPT_ID: ${{ secrets.HOSTINGER_POST_INSTALL_SCRIPT_ID }}
        run: |
          echo "üîÑ Recreating VPS OS..."

          if [[ "${{ github.event.inputs.use_post_install_script }}" == "true" ]]; then
            echo "Using post-install script for binary caching"
            RESPONSE=$(bash scripts/hostinger-api.sh recreate \
              "${{ github.event.inputs.template_id }}" \
              "${{ steps.gen-password.outputs.password }}" \
              "$HOSTINGER_POST_INSTALL_SCRIPT_ID")
          else
            echo "Skipping post-install script"
            RESPONSE=$(bash scripts/hostinger-api.sh recreate \
              "${{ github.event.inputs.template_id }}" \
              "${{ steps.gen-password.outputs.password }}")
          fi

          ACTION_ID=$(echo "$RESPONSE" | jq -r '.id')
          echo "recreate_action_id=$ACTION_ID" >> $GITHUB_OUTPUT
          echo "Recreate action ID: $ACTION_ID"

      - name: Wait for VPS rebuild to complete
        env:
          HOSTINGER_API_KEY: ${{ secrets.HOSTINGER_API_KEY }}
          HOSTINGER_VPS_ID: ${{ secrets.HOSTINGER_VPS_ID }}
        run: |
          echo "‚è≥ Waiting for VPS rebuild to complete (this takes ~5 minutes)..."
          bash scripts/hostinger-api.sh wait-action ${{ steps.recreate-vps.outputs.recreate_action_id }} 600

      - name: Get new VPS public IP
        id: get-vps-ip
        env:
          HOSTINGER_API_KEY: ${{ secrets.HOSTINGER_API_KEY }}
          HOSTINGER_VPS_ID: ${{ secrets.HOSTINGER_VPS_ID }}
        run: |
          echo "üåê Fetching new VPS public IP..."
          RESPONSE=$(bash scripts/hostinger-api.sh get-details)
          VPS_IP=$(echo "$RESPONSE" | jq -r '.ipv4[0].address')
          echo "vps_ip=$VPS_IP" >> $GITHUB_OUTPUT
          echo "VPS Public IP: $VPS_IP"

      - name: Wait for SSH to be available
        run: |
          echo "‚è≥ Waiting for SSH to be available on ${{ steps.get-vps-ip.outputs.vps_ip }}..."
          for i in {1..30}; do
            if ssh -i ~/.ssh/vps_key -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
                root@${{ steps.get-vps-ip.outputs.vps_ip }} 'echo "SSH ready"' 2>/dev/null; then
              echo "‚úÖ SSH is ready"
              break
            fi
            echo "Attempt $i/30 failed, waiting 10s..."
            sleep 10
          done

      - name: Bootstrap VPS with Ansible
        env:
          TAILSCALE_AUTH_KEY: ${{ steps.gen-tailscale-key.outputs.auth_key }}
        run: |
          echo "üîß Bootstrapping VPS with Ansible..."
          cd infra/ansible

          # Create temporary inventory
          cat > inventory/rebuild-temp.ini <<EOF
          [vps]
          rebuild-vps ansible_host=${{ steps.get-vps-ip.outputs.vps_ip }} ansible_user=root ansible_ssh_private_key_file=~/.ssh/vps_key ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

          # Run optimized bootstrap playbook
          ansible-playbook -i inventory/rebuild-temp.ini \
            -e "tailscale_auth_key=$TAILSCALE_AUTH_KEY" \
            playbooks/bootstrap-optimized.yml

      - name: Wait for Tailscale device to appear
        env:
          TAILSCALE_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
          TAILSCALE_TAILNET: ${{ secrets.TAILSCALE_TAILNET }}
        run: |
          echo "‚è≥ Waiting for VPS to join Tailscale network..."
          source scripts/load-secrets.sh
          bash scripts/tailscale-api.sh wait-for-device hill90-vps 120

      - name: Get Tailscale IP
        id: get-tailscale-ip
        env:
          TAILSCALE_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
          TAILSCALE_TAILNET: ${{ secrets.TAILSCALE_TAILNET }}
        run: |
          echo "üåê Fetching Tailscale IP..."
          source scripts/load-secrets.sh
          TS_IP=$(bash scripts/tailscale-api.sh get-ip hill90-vps)
          echo "tailscale_ip=$TS_IP" >> $GITHUB_OUTPUT
          echo "Tailscale IP: $TS_IP"

      - name: Deploy services via Tailscale
        run: |
          echo "üöÄ Deploying services via Tailscale..."
          ssh -i ~/.ssh/vps_key -o StrictHostKeyChecking=no \
            deploy@${{ steps.get-tailscale-ip.outputs.tailscale_ip }} \
            'cd /opt/hill90/app && \
             export SOPS_AGE_KEY_FILE=/opt/hill90/secrets/keys/keys.txt && \
             bash scripts/deploy.sh prod'

      - name: Wait for services to start
        run: |
          echo "‚è≥ Waiting for services to start..."
          sleep 60

      - name: Verify health
        run: |
          echo "üè• Verifying service health..."
          # TODO: Add health check endpoint verification
          # For now, just check if we can SSH
          ssh -i ~/.ssh/vps_key -o StrictHostKeyChecking=no \
            deploy@${{ steps.get-tailscale-ip.outputs.tailscale_ip }} \
            'docker ps --format "table {{.Names}}\t{{.Status}}"'

      - name: Update secrets with new IPs
        run: |
          echo "üíæ Updating secrets with new IPs..."
          make secrets-update KEY=VPS_IP VALUE="${{ steps.get-vps-ip.outputs.vps_ip }}"
          make secrets-update KEY=TAILSCALE_IP VALUE="${{ steps.get-tailscale-ip.outputs.tailscale_ip }}"

      - name: Commit updated secrets
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add infra/secrets/prod.enc.env
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update VPS IPs after rebuild

            - VPS Public IP: ${{ steps.get-vps-ip.outputs.vps_ip }}
            - Tailscale IP: ${{ steps.get-tailscale-ip.outputs.tailscale_ip }}
            - Rebuild action: ${{ github.run_id }}"
            git push
          fi

      - name: Cleanup backup files
        if: always()
        run: |
          # Remove backup files created by secrets-update
          find infra/secrets -name "*.backup.*" -type f -delete || true

      - name: Summary
        if: success()
        run: |
          echo "üéâ VPS rebuild complete!"
          echo ""
          echo "üìä New VPS details:"
          echo "  Public IP: ${{ steps.get-vps-ip.outputs.vps_ip }}"
          echo "  Tailscale IP: ${{ steps.get-tailscale-ip.outputs.tailscale_ip }}"
          echo "  Template: ${{ github.event.inputs.template_id }}"
          echo ""
          echo "‚úÖ Next steps:"
          echo "  1. Verify services: make health"
          echo "  2. SSH via Tailscale: make ssh"
          echo "  3. Check logs: make logs"
