name: Config VPS (Infrastructure Bootstrap)

# Manual trigger only
# Configures VPS infrastructure: Docker, Tailscale, Traefik, Portainer
# Does NOT deploy application services - use Deploy workflows separately
on:
  workflow_dispatch:
    inputs:
      vps_ip:
        description: 'VPS Public IP address'
        required: true
        type: string

jobs:
  validate:
    name: Validate Prerequisites
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate VPS IP format
        run: |
          VPS_IP="${{ github.event.inputs.vps_ip }}"
          if ! [[ "$VPS_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid IP address format"
            exit 1
          fi
          echo "‚úÖ VPS IP valid: $VPS_IP"

      - name: Validate Ansible playbooks exist
        run: |
          echo "üîç Validating Ansible playbooks..."

          PLAYBOOKS=(
            "infra/ansible/playbooks/01-system-prep.yml"
            "infra/ansible/playbooks/02-firewall.yml"
            "infra/ansible/playbooks/03-tailscale.yml"
            "infra/ansible/playbooks/04-ssh-lockdown.yml"
            "infra/ansible/playbooks/05-docker.yml"
            "infra/ansible/playbooks/06-sops.yml"
            "infra/ansible/playbooks/07-age.yml"
            "infra/ansible/playbooks/08-secrets.yml"
            "infra/ansible/playbooks/09-traefik.yml"
            "infra/ansible/playbooks/10-portainer.yml"
            "infra/ansible/playbooks/bootstrap.yml"
          )

          for playbook in "${PLAYBOOKS[@]}"; do
            if [[ ! -f "$playbook" ]]; then
              echo "‚ùå Missing: $playbook"
              exit 1
            fi
          done

          echo "‚úÖ All Ansible playbooks present"

  config:
    name: Configure VPS Infrastructure
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-actions

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/remote.hill90.com
          chmod 600 ~/.ssh/remote.hill90.com

      - name: Setup SOPS/age for secrets
        run: |
          # Install SOPS
          curl -L -o /tmp/sops https://github.com/getsops/sops/releases/download/v3.9.0/sops-v3.9.0.linux.amd64
          chmod +x /tmp/sops
          sudo mv /tmp/sops /usr/local/bin/sops

          # Setup age key
          mkdir -p ~/.config/sops/age
          echo "${{ secrets.SOPS_AGE_KEY }}" > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt

      # SSH verification removed - recreate-vps already verified SSH is working
      # and auto-triggers config-vps immediately to minimize timing gaps

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Capture Tailscale auth key
        id: get-tailscale-auth-key
        run: |
          echo "üîë Extracting Tailscale auth key..."
          TAILSCALE_AUTH_KEY=$(sops -d --extract '["TAILSCALE_AUTH_KEY"]' infra/secrets/prod.enc.env)
          echo "::add-mask::$TAILSCALE_AUTH_KEY"
          echo "tailscale_auth_key=$TAILSCALE_AUTH_KEY" >> $GITHUB_OUTPUT

      - name: Create age key file for Ansible
        run: |
          echo "üîê Creating age key file for Ansible..."
          mkdir -p infra/secrets/keys
          echo "${{ secrets.SOPS_AGE_KEY }}" > infra/secrets/keys/age-prod.key
          chmod 600 infra/secrets/keys/age-prod.key

      - name: Run make config-vps
        env:
          VPS_IP: ${{ github.event.inputs.vps_ip }}
          TAILSCALE_AUTH_KEY: ${{ steps.get-tailscale-auth-key.outputs.tailscale_auth_key }}
          SOPS_AGE_KEY_FILE: /home/runner/.config/sops/age/keys.txt
        run: |
          echo "üîß Running VPS bootstrap via make config-vps..."
          make config-vps VPS_IP=$VPS_IP

      - name: Capture Tailscale IP from secrets
        id: get-tailscale-ip
        run: |
          echo "üåê Reading Tailscale IP from encrypted secrets..."
          TAILSCALE_IP=$(sops -d --extract '["TAILSCALE_IP"]' infra/secrets/prod.enc.env)
          echo "::add-mask::$TAILSCALE_IP"
          echo "tailscale_ip=$TAILSCALE_IP" >> $GITHUB_OUTPUT
          echo "‚úÖ Tailscale IP: $TAILSCALE_IP"

      - name: Commit updated secrets
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet infra/secrets/prod.enc.env; then
            echo "No changes to commit"
          else
            git add infra/secrets/prod.enc.env
            git commit -m "Update TAILSCALE_IP after VPS config

          Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
            git push
          fi

      - name: Summary
        if: success()
        run: |
          echo "üéâ VPS Configuration Complete!"
          echo ""
          echo "üìä Configuration details:"
          echo "  VPS Public IP: ${{ github.event.inputs.vps_ip }}"
          echo "  VPS Tailscale IP: ${{ steps.get-tailscale-ip.outputs.tailscale_ip }}"
          echo ""
          echo "‚úÖ Infrastructure deployed:"
          echo "  ‚Ä¢ Traefik: https://traefik.hill90.com (Tailscale-only)"
          echo "  ‚Ä¢ Portainer: https://portainer.hill90.com (Tailscale-only)"
          echo ""
          echo "‚ö†Ô∏è  APPLICATION SERVICES NOT DEPLOYED"
          echo "    Infrastructure only: Traefik + Portainer"
          echo ""
          echo "‚úÖ Next steps:"
          echo "  1. Setup Portainer admin: https://portainer.hill90.com"
          echo "  2. Deploy application: Trigger 'Deploy (Production)' workflow"
          echo "  3. SSH access: ssh -i ~/.ssh/remote.hill90.com deploy@${{ steps.get-tailscale-ip.outputs.tailscale_ip }}"
